<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Excel æ•°æ®å¤„ç†å·¥å…·ï¼ˆç»ˆæç‰ˆï¼‰</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        .data-panel { border: 1px solid #dee2e6; border-radius: 5px; margin: 1rem 0; }
        .table-container { max-height: 60vh; overflow-y: auto; }
        .table thead th { position: sticky; top: 0; background: white; z-index: 1; }
        .table-hover tbody tr:hover { background-color: rgba(0, 123, 255, 0.05); }
        .status-badge { font-size: 0.9rem; }
        .toast { position: fixed; bottom: 20px; right: 20px; }
        .preset-tag { margin: 2px; cursor: pointer; }
        .preset-btns { margin: 10px 0; gap: 5px; }
        .preset-btn { padding: 5px 10px; }
        .loading-overlay { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(255,255,255,0.8); 
            z-index: 1000; 
            justify-content: center; 
            align-items: center;
        }
    </style>
</head>
<body>
    <div class="loading-overlay">
        <div class="spinner-border text-primary" role="status"></div>
    </div>

    <div class="container py-4">
        <!-- æ–‡ä»¶ä¸Šä¼ åŒº -->
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <h5 class="card-title mb-3">ğŸ“ ä¸Šä¼  Excel æ–‡ä»¶</h5>
                <input type="file" id="fileInput" class="form-control" accept=".xlsx, .xls">
              
                <!-- é¢„è®¾ç®¡ç†åŒº -->
                <div class="mt-4">
                    <small class="text-muted">å¿«æ·é¢„è®¾ï¼š</small>
                    <div class="preset-btns d-flex flex-wrap" id="presetButtons"></div>
                </div>

                <div class="mt-3">
                    <small class="text-muted">è‡ªå®šä¹‰åˆ é™¤åˆ—ï¼ˆç‚¹å‡»æ ‡ç­¾æˆ–ç¼–è¾‘ï¼‰ï¼š</small>
                    <div id="presetTags" class="d-flex flex-wrap gap-2 my-2"></div>
                    <input type="text" id="predefinedColumns" class="form-control" 
                           placeholder="è¾“å…¥åˆ—åï¼Œç”¨é€—å·åˆ†éš”">
                </div>
            </div>
        </div>

        <!-- æ“ä½œé¢æ¿ -->
        <div id="operationPanel" class="d-none">
            <!-- åˆ—é€‰æ‹©åŒº -->
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title">âš™ï¸ åˆ—ç®¡ç†é¢æ¿</h5>
                        <span id="status" class="status-badge badge bg-secondary">åŸå§‹æ•°æ®</span>
                    </div>
                    <div id="columnCheckboxes" class="d-flex flex-wrap gap-3"></div>
                </div>
            </div>

            <!-- åŠŸèƒ½æŒ‰é’®ç»„ -->
            <div class="btn-toolbar mb-4 gap-2">
                <button class="btn btn-primary" onclick="processData()">â–¶ï¸ å¤„ç†æ•°æ®</button>
                <button class="btn btn-success" onclick="downloadFile()">â¬ ä¸‹è½½ç»“æœ</button>
                <button class="btn btn-warning" onclick="resetData()">â®ï¸ è¿˜åŸæ•°æ®</button>
                <button class="btn btn-info" onclick="copyToClipboard()">ğŸ“‹ å¤åˆ¶æ•°æ®</button>
                <button class="btn btn-outline-danger" onclick="clearPreset()">âŒ æ¸…ç©ºé¢„è®¾</button>
            </div>

            <!-- æ•°æ®å±•ç¤ºåŒº -->
            <div class="data-panel">
                <div class="table-container">
                    <table class="table table-hover table-striped" id="dataTable">
                        <thead class="table-light"></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- æç¤ºä¿¡æ¯ -->
        <div id="errorAlert" class="alert alert-danger d-none mt-4"></div>
        <div id="copyToast" class="toast" role="alert">
            <div class="toast-header">
                <strong class="me-auto">ç³»ç»Ÿæç¤º</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body"></div>
        </div>
    </div>

    <script>
        // ==================== æ ¸å¿ƒé…ç½® ====================
        const PRESET_CONFIG = {
            'è‚¡ç¥¨æ¶¨åœæ•°æ®': ['åºå·',
			'è‚¡ç¥¨é“¾æ¥',
			'æ¶¨åœæ˜ç»†æ•°æ®',
			'æ¶¨åœæ˜ç»†æ•°æ®é“¾æ¥',
			'æ¶¨åœåŸå› ç±»åˆ«é“¾æ¥',
			'è‚¡æµé€šå¸‚å€¼é“¾æ¥',
			'æ¶¨åœç±»å‹',
			'æ¶¨åœç±»å‹1',
			'æ¶¨åœç±»å‹2',
			'æ¶¨åœ'
			],
            'æ•æ„Ÿä¿¡æ¯åˆ—': ['æ‰‹æœºå·', 'èº«ä»½è¯å·', 'åœ°å€'],
            'ç³»ç»Ÿå­—æ®µåˆ—': ['åˆ›å»ºæ—¶é—´', 'æ›´æ–°æ—¶é—´', 'æ“ä½œäºº'],
            'æµ‹è¯•æ•°æ®åˆ—': ['æµ‹è¯•ID', 'æ¨¡æ‹Ÿæ•°æ®', 'è°ƒè¯•æ ‡è®°']
        };

        // ==================== å…¨å±€å˜é‡ ====================
        let originalData = [];
        let processedData = [];
        let currentColumns = [];

        // ==================== åˆå§‹åŒ–å‡½æ•° ====================
        function initPresetButtons() {
            const container = document.getElementById('presetButtons');
            container.innerHTML = Object.keys(PRESET_CONFIG).map(name => `
                <button class="preset-btn btn btn-outline-primary btn-sm" 
                        onclick="applyPreset('${name}')">${name}</button>
            `).join('');
        }

        // ==================== æ–‡ä»¶å¤„ç† ====================
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            showLoading(true);
            const reader = new FileReader();
          
            reader.onload = function(e) {
                try {
                    const workbook = XLSX.read(e.target.result, { type: 'array' });
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    const headers = jsonData[0];
                    originalData = jsonData.slice(1).map(row => 
                        headers.reduce((obj, key, i) => ({ ...obj, [key]: row[i] }), {})
                    );

                    initUI(headers);
                    autoProcessAfterUpload();
                } catch (error) {
                    showError('æ–‡ä»¶è§£æå¤±è´¥: ' + error.message);
                } finally {
                    showLoading(false);
                }
            };
            reader.onerror = () => showError('æ–‡ä»¶è¯»å–å¤±è´¥');
            reader.readAsArrayBuffer(file);
        });

        // ==================== æ ¸å¿ƒåŠŸèƒ½ ====================
        function initUI(headers) {
            currentColumns = headers;
            document.getElementById('operationPanel').classList.remove('d-none');
            initPresetButtons();
            initColumnCheckboxes(headers);
            bindEvents();
            autoProcessAfterUpload();
        }

        function initColumnCheckboxes(headers) {
            document.getElementById('columnCheckboxes').innerHTML = headers.map(header => `
                <div class="form-check">
                    <input class="form-check-input preset-checkbox" type="checkbox" 
                           value="${header}" id="col-${header}">
                    <label class="form-check-label" for="col-${header}">${header}</label>
                </div>
            `).join('');
        }

        function bindEvents() {
            const presetInput = document.getElementById('predefinedColumns');
            presetInput.addEventListener('input', () => {
                updateCheckboxesFromPreset();
                if (presetInput.value.trim()) processData();
            });

            document.querySelectorAll('.preset-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    updatePresetFromCheckboxes();
                    updatePresetTags();
                    processData();
                });
            });
        }

        // ==================== æ•°æ®å¤„ç† ====================
        function processData() {
            try {
                const columnsToDrop = getSelectedColumns();
                processedData = originalData.map(row => 
                    Object.fromEntries(
                        Object.entries(row).filter(([key]) => !columnsToDrop.includes(key))
                    )
                );
                showProcessedResult(processedData);
                updateStatus('å·²å¤„ç†æ•°æ®', 'success');
            } catch (error) {
                showError('æ•°æ®å¤„ç†å¤±è´¥: ' + error.message);
            }
        }

        // ==================== é¢„è®¾ç®¡ç† ====================
        function applyPreset(presetName) {
            const columns = PRESET_CONFIG[presetName];
            if (!columns) return;

            const encoded = columns.map(encodePresetColumn).join(',');
            document.getElementById('predefinedColumns').value = encoded;
            updateCheckboxesFromPreset();
            if (originalData.length) processData();
            showToast(`å·²åº”ç”¨é¢„è®¾: ${presetName}`);
        }

        function clearPreset() {
            document.getElementById('predefinedColumns').value = '';
            document.querySelectorAll('.preset-checkbox').forEach(cb => cb.checked = false);
            updatePresetTags();
            if (originalData.length) resetData();
            showToast('é¢„è®¾å·²æ¸…ç©º');
        }

        // ==================== å·¥å…·å‡½æ•° ====================
        function autoProcessAfterUpload() {
            const hasPreset = document.getElementById('predefinedColumns').value.trim() !== '';
            hasPreset ? processData() : showProcessedResult(originalData);
        }

        function showProcessedResult(data) {
            const headers = Object.keys(data[0] || {});
            document.getElementById('dataTable').innerHTML = `
                <thead class="table-light">
                    <tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>
                </thead>
                <tbody>
                    ${data.slice(0, 1000).map(row => `
                        <tr>${headers.map(h => `<td>${row[h] ?? ''}</td>`).join('')}</tr>
                    `).join('')}
                </tbody>
            `;
        }

        // ==================== è¾…åŠ©å‡½æ•° ====================
        function updatePresetFromCheckboxes() {
            document.getElementById('predefinedColumns').value = 
                getSelectedColumns().map(encodePresetColumn).join(',');
            updatePresetTags();
        }

        function updateCheckboxesFromPreset() {
            const preset = document.getElementById('predefinedColumns').value
                .split(',')
                .map(s => decodePresetColumn(s.trim()))
                .filter(Boolean);

            document.querySelectorAll('.preset-checkbox').forEach(checkbox => {
                checkbox.checked = preset.includes(checkbox.value);
            });
            updatePresetTags();
        }

        function updatePresetTags() {
            document.getElementById('presetTags').innerHTML = 
                document.getElementById('predefinedColumns').value
                    .split(',')
                    .map(s => s.trim())
                    .filter(Boolean)
                    .map(col => `
                        <span class="preset-tag badge bg-primary" 
                            onclick="togglePresetColumn('${encodePresetColumn(col)}')">
                            ${decodePresetColumn(col)} Ã—
                        </span>
                    `).join('');
        }

        function encodePresetColumn(col) {
            return col.replace(/,/g, '__COMMA__');
        }

        function decodePresetColumn(encoded) {
            return encoded.replace(/__COMMA__/g, ',');
        }

        function getSelectedColumns() {
            return Array.from(document.querySelectorAll('.preset-checkbox:checked'))
                       .map(cb => cb.value);
        }

        // ==================== UI äº¤äº’ ====================
        function resetData() {
            showProcessedResult(originalData);
            updateStatus('åŸå§‹æ•°æ®', 'secondary');
        }

        function downloadFile() {
            if (!processedData.length) return showError('è¯·å…ˆå¤„ç†æ•°æ®');
            try {
                const worksheet = XLSX.utils.json_to_sheet(processedData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, 'å¤„ç†ç»“æœ');
                XLSX.writeFile(workbook, 'å¤„ç†ç»“æœ.xlsx');
            } catch (error) {
                showError('æ–‡ä»¶ç”Ÿæˆå¤±è´¥: ' + error.message);
            }
        }

        function copyToClipboard() {
            if (!processedData.length) return showError('è¯·å…ˆå¤„ç†æ•°æ®');
            try {
                const headers = [...document.querySelectorAll('#dataTable th')].map(th => th.innerText);
                const tsvContent = [
                    headers.join('\t'),
                    ...processedData.map(row => headers.map(h => row[h] ?? '').join('\t'))
                ].join('\n');
                navigator.clipboard.writeText(tsvContent).then(() => {
                    showToast('æ•°æ®å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                }).catch(() => showError('è¯·æ‰‹åŠ¨é€‰æ‹©æ•°æ®å¤åˆ¶'));
            } catch (error) {
                showError('å¤åˆ¶å¤±è´¥: ' + error.message);
            }
        }

        function togglePresetColumn(encodedCol) {
            const col = decodePresetColumn(encodedCol);
            const checkbox = document.querySelector(`.preset-checkbox[value="${col}"]`);
            if (checkbox) {
                checkbox.checked = !checkbox.checked;
                checkbox.dispatchEvent(new Event('change'));
            }
        }

        // ==================== çŠ¶æ€ç®¡ç† ====================
        function updateStatus(text, type = 'secondary') {
            const status = document.getElementById('status');
            status.className = `status-badge badge bg-${type}`;
            status.textContent = text;
        }

        function showLoading(show) {
            document.querySelector('.loading-overlay').style.display = show ? 'flex' : 'none';
        }

        function showError(msg) {
            const alertDiv = document.getElementById('errorAlert');
            alertDiv.textContent = msg;
            alertDiv.classList.remove('d-none');
            setTimeout(() => alertDiv.classList.add('d-none'), 5000);
        }

        function showToast(msg) {
            const toastEl = document.getElementById('copyToast');
            const toastBody = toastEl.querySelector('.toast-body');
            toastBody.textContent = msg;
            new bootstrap.Toast(toastEl).show();
        }
    </script>
</body>
</html>